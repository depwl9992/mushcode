<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, June 30, 2007, 10:48  -->
<!-- MuClient version 4.13 -->

<!-- Plugin "Chat_Redirector" generated by Plugin Wizard -->

<!--
Edit plugin and change "chat_world" variable to be the name of the 
world you want chats to go to.
-->

<muclient>
<plugin
   name="Chat_Redirector"
   author="Nick Gammon"
   id="cb84a526b476f69f403517da"
   language="Lua"
   purpose="Redirects chat messages to another world"
   date_written="2007-06-30 10:45:35"
   requires="4.08"
   version="1.0"
   save_state="y"
   >
<description trim="y">
<![CDATA[
Redirects chats to the specified world.

Add or modify "chat" triggers to capture different sorts of message.

Change the variable "chat_world" to be the name of the world chats are to go to.
]]>
</description>

</plugin>

<!--  Triggers  -->

<triggers>

  <trigger
   enabled="n"
   match="^(\(.+\): )?[A-Za-z]+ (says|yells|tells you), &quot;.+"
   regexp="y"
   script="redirect"
   group="chatred"
   sequence="100"
  >
  </trigger>

  <trigger
   enabled="n"
   match="^You (tell|whisper) .+, &quot;.+"
   regexp="y"
   script="redirect"
   group="chatred"
   sequence="100"
  >
  </trigger>

  <trigger
   enabled="n"
   match="^(.+) pages: (.*?)$"
   regexp="y"
   script="redirect"
   group="chatred"
   sequence="100"
  >
  </trigger>

  <trigger
   enabled="n"
   match="^You paged (.*?) with \'(.*?)\'$"
   regexp="y"
   script="redirect"
   group="chatred"
   sequence="100"
  >
  </trigger>

  <trigger
   enabled="n"
   match="^(.*?)\> (.*?)$"
   regexp="y"
   script="redirect"
   name="pet_routing"
   group="chatred"
   sequence="10"
  >
  </trigger>
</triggers>

<aliases>
  <alias
   match="^chat redirect (on|off)(\/omit?)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   ignore_case="y"
   keep_evaluating="y"
   sequence="100"
  >
  <send> 
   if "%1" == "on" then
     EnableTriggerGroup("chatred",true)
     SetVariable("redirect_enable","true")
     if "%2" ~= "/omit" then
       ColourNote("red","black","Chat Redirect is ON")
     end -- if
   else
     EnableTriggerGroup("chatred",false)
     SetVariable("redirect_enable","false")
     if "%2" ~= "/omit" then
       ColourNote("red","black","Chat Redirect is OFF")
     end -- if
   end -- if
  </send>
  </alias>     
</aliases>

<!--  Script  -->


<script>
<![CDATA[
chat_world = "Chat Window"
local first_time = true

function OnPluginInstall()
  if GetVariable("redirect_enable") == "false" then
  	ColourNote("yellow","black","Chat Redirects are currently disabled.")
  	ColourNote("yellow","black","CHAT REDIRECT ON to enable them.")
    Execute("chat redirect off/omit")
  else
    ColourNote("yellow","black","Chat Redirects are currently enabled.")
    ColourNote("yellow","black","CHAT REDIRECT OFF to disable them.")
    Execute("chat redirect on/omit")
  end -- if
end -- function

function redirect (name, line, wildcards, styles)

  -- try to find "chat" world
  local w = GetWorld (chat_world)  -- get "chat" world

  -- if not found, try to open it
  if first_time and not w then
    local filename = GetInfo (67) .. chat_world .. ".mcl"
    Open (filename)
    w = GetWorld (chat_world)  -- try again
    if not w then
      ColourNote ("white", "red", "Can't open chat world file: " .. filename)
      first_time = false  -- don't repeatedly show failure message
    end -- can't find world 
  end -- can't find world first time around

  if w then  -- if present
    for _, v in ipairs (styles) do
	  str, en, cap1, cap2 = string.find(v.text, "^(.*)\>%s+(.*)$")
      if cap2 == nil then
        cap2 = v.text
      end -- if
      w:ColourTell (RGBColourToName (v.textcolour), 
                    RGBColourToName (v.backcolour), 
                    cap2) -- was v.text  
    end -- for each style run
    w:Note ("")  -- wrap up line

  end -- world found


  -- if ends with quote, end of multi-line chat
--  if line:sub (-1) == '"' or line:sub (-1) == "'" then
--    EnableTrigger ("multi_line_chat", false)  -- no more lines to go
--  else
--    EnableTrigger ("multi_line_chat", true)  -- capture subsequent lines
--  end -- if

end -- function redirect 

]]>
</script>
</muclient>
